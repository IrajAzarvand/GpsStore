# مستندات جامع پروژه GpsStore

این فایل شامل تمام اطلاعات فنی، ساختار پروژه، دیتابیس، نحوه دیپلوی و عیب‌یابی پروژه GpsStore است.

---

## فهرست مطالب
1. [معرفی پروژه](#معرفی-پروژه)
2. [ساختار فایل‌ها](#ساختار-فایل‌ها)
3. [توضیحات اجزای اصلی](#توضیحات-اجزای-اصلی)
4. [دیتابیس و مدل‌ها](#دیتابیس-و-مدل‌ها)
5. [گیرنده GPS (GPS Receiver)](#گیرنده-gps-gps-receiver)
6. [داکر و دیپلوی](#داکر-و-دیپلوی)
7. [راهنمای دیپلوی روی سرور](#راهنمای-دیپلوی-روی-سرور)
8. [عیب‌یابی (Troubleshooting)](#عیب‌یابی-troubleshooting)

---

## معرفی پروژه

پروژه **GpsStore** یک سیستم ردیابی GPS مبتنی بر وب است که با استفاده از **Django** (بک‌اند)، **PostgreSQL** (دیتابیس) و **Docker** (زیرساخت) پیاده‌سازی شده است. این سیستم قابلیت دریافت داده‌های موقعیت مکانی از دستگاه‌های GPS مختلف (از طریق پروتکل‌های TCP/UDP/MQTT)، ذخیره آن‌ها و نمایش موقعیت‌ها روی نقشه را دارد.

---

## ساختار فایل‌ها

```
GpsStore/
├── apps/                       # اپلیکیشن‌های Django
│   ├── gps_devices/            # مدیریت دستگاه‌ها و دریافت داده‌های GPS
│   │   ├── management/commands/gps_receiver.py  # اسکریپت اصلی دریافت داده (TCP/UDP)
│   │   ├── consumers.py        # مدیریت WebSocket و گروه‌های کاربری
│   │   ├── routing.py          # مسیردهی WebSocket
│   │   ├── signals.py          # سیگنال‌های پخش زنده موقعیت
│   │   └── models.py           # مدل‌های مربوط به دستگاه و داده‌های خام
│   ├── tracking/               # مدیریت موقعیت‌ها و ردیابی
│   │   └── models.py           # مدل‌های مربوط به نقاط مکانی و Geofence
│   └── ...
├── gps_store/                  # تنظیمات اصلی پروژه Django
│   ├── settings.py             # تنظیمات پروژه (دیتابیس، اپ‌ها و ...)
│   └── ...
├── nginx/                      # تنظیمات وب‌سرور Nginx
│   └── sites-enabled/gpsstore  # کانفیگ Nginx برای دامنه و پورت‌ها
├── scripts/                    # اسکریپت‌های کمکی
├── systemd/                    # فایل‌های سرویس Systemd
│   └── gps-receiver.service    # سرویس اجرای گیرنده GPS در پس‌زمینه
├── templates/                  # قالب‌های HTML
│   └── gps_devices/map_v2.html # قالب جدید نقشه با قابلیت‌های زنده
├── Dockerfile                  # دستورالعمل ساخت ایمیج داکر پروژه
├── docker-compose.yml          # تعریف سرویس‌های داکر (web, db, nginx, redis)
├── full_setup.sh               # اسکریپت جامع راه‌اندازی پروژه (بیلد، مایگریشن و ...)
├── manage.py                   # ابزار مدیریت Django
├── requirements.txt            # لیست کتابخانه‌های پایتون
├── HQ_Decoder.py               # کلاس دیکدر برای پروتکل‌های HQ (دستگاه‌های GPS)
├── run_gps_receiver.py         # اسکریپت کمکی برای اجرای گیرنده GPS
└── verify_fix.py               # اسکریپت تست و بررسی نشت اتصال دیتابیس
```

---

## توضیحات اجزای اصلی

### 1. `full_setup.sh`
این مهم‌ترین اسکریپت برای راه‌اندازی پروژه است. وظایف آن:
- نصب Docker و Docker Compose (در صورت نیاز).
- ساخت فایل `.env` با تنظیمات امنیتی و آی‌پی سرور.
- بیلد کردن ایمیج‌های داکر.
- اجرای کانتینرها.
- اجرای Migrationهای دیتابیس و جمع‌آوری فایل‌های استاتیک.
- تنظیم فایروال (UFW).

### 2. `apps/gps_devices/management/commands/gps_receiver.py`
قلب تپنده سیستم دریافت داده. این اسکریپت یک دستور Django (`python manage.py gps_receiver`) است که:
- روی پورت **5000** گوش می‌دهد (TCP و UDP).
- داده‌های خام را از دستگاه‌ها دریافت می‌کند.
- با استفاده از `HQ_Decoder` داده‌ها را پارس می‌کند.
- داده‌ها را در دیتابیس ذخیره می‌کند.
- **بهینه‌سازی اخیر**: برای جلوگیری از مشکل "Too many clients"، از `ThreadPoolExecutor` با محدودیت 20 ترد و Timeout ده ثانیه‌ای استفاده می‌کند و اتصالات دیتابیس را به طور تهاجمی می‌بندد.

### 3. `HQ_Decoder.py`
کلاسی برای ترجمه و دیکد کردن بسته‌های داده‌ای که از دستگاه‌های GPS (معمولاً با پروتکل HQ) ارسال می‌شوند.

### 4. معماری نقشه زنده (Real-Time Map)
سیستم نمایش زنده موقعیت‌ها در نسخه جدید (`map_v2.html`) بازنویسی شده است.

#### الف) Backend (Django Channels & Signals)
- **تکنولوژی**: از **Django Channels** و **Redis** برای ارتباط WebSocket استفاده می‌شود.
- **مسیر WebSocket**: آدرس `ws/device-updates/` به `DeviceUpdateConsumer` متصل است.
- **مدیریت دسترسی (Role-Based)**:
    - **ادمین‌ها**: به گروه `admins_group` متصل می‌شوند و آپدیت تمام دستگاه‌ها را دریافت می‌کنند.
    - **کاربران عادی**: به گروه اختصاصی `user_group_{user_id}` متصل می‌شوند و فقط آپدیت دستگاه‌های تخصیص‌یافته به خود را می‌بینند.
- **Signals**: با ذخیره هر رکورد در `LocationData`، سیگنال `broadcast_device_update` فعال شده و پیام را به گروه‌های مرتبط ارسال می‌کند.

#### ب) Frontend (Leaflet & Neshan)
- **قالب**: فایل `templates/gps_devices/map_v2.html`.
- **نقشه**: استفاده از تایل‌های **Neshan Maps**.
- **ویژگی‌ها**:
    - نمایش سلسله‌مراتب کاربران (Main User -> Sub Users -> Devices) در سایدبار.
    - آپدیت آنی موقعیت، سرعت، وضعیت و آیکون‌ها بدون رفرش صفحه.
    - استفاده از آیکون‌های اختصاصی برای وضعیت‌های مختلف (Moving, Parked, Alarm, Offline).
    - مکانیزم Polling (هر 5 ثانیه) به عنوان جایگزین در صورت قطع WebSocket.

---

## دیتابیس و مدل‌ها

دیتابیس پروژه **PostgreSQL** است و روی پورت پیش‌فرض 5432 اجرا می‌شود.

### مدل‌های اصلی (`apps/gps_devices/models.py`)

1.  **`Device`**: اطلاعات دستگاه‌های ردیاب.
    - `imei`: شناسه یکتای دستگاه.
    - `device_id`: شناسه جایگزین.
    - `status`: وضعیت دستگاه (active, inactive).
    - `last_location_...`: آخرین موقعیت مکانی ثبت شده.

2.  **`RawGPSData`**: داده‌های خام دریافتی.
    - هر بسته‌ای که به پورت 5000 می‌رسد ابتدا اینجا ذخیره می‌شود.
    - `status`: وضعیت پردازش (pending, approved, rejected). اگر داده‌ای توسط دیکدر تایید نشود، اینجا با وضعیت pending و پیام خطا می‌ماند.

3.  **`Protocol`**: تعریف پروتکل‌های ارتباطی (TCP, UDP, MQTT).

### مدل‌های ردیابی (`apps/tracking/models.py`)

1.  **`LocationData`**: نقاط مکانی پردازش شده.
    - `latitude`, `longitude`: مختصات جغرافیایی.
    - `speed`, `heading`: سرعت و جهت.
    - `timestamp`: زمان ثبت موقعیت.

2.  **`Geofence`**: محدوده‌های جغرافیایی تعریف شده توسط کاربر (دایره یا چندضلعی).

3.  **`Alert`**: هشدارهای سیستم (مثل ورود/خروج از Geofence، سرعت غیرمجاز، قطع شدن باتری).

---

## گیرنده GPS (GPS Receiver)

این سرویس مسئول ارتباط با دستگاه‌های سخت‌افزاری است.

- **پورت**: 5000 (TCP/UDP)
- **نحوه اجرا**: به صورت یک سرویس Systemd (`gps-receiver.service`) که داخل کانتینر `web` دستور `python manage.py gps_receiver` را اجرا می‌کند.
- **مدیریت منابع**:
    - از `ThreadPoolExecutor` برای مدیریت همزمان کلاینت‌ها استفاده می‌کند.
    - هر کلاینت TCP اگر تا 10 ثانیه داده نفرستد، قطع می‌شود.
    - اتصالات دیتابیس پس از هر عملیات بسته می‌شوند تا از نشت اتصال (Connection Leak) جلوگیری شود.

---

## داکر و دیپلوی

پروژه کاملاً داکرایز شده است.

### `Dockerfile`
- از ایمیج پایه `python:3.10-slim` استفاده می‌کند.
- کتابخانه‌های سیستمی لازم (مثل `libpq-dev`, `gcc`) را نصب می‌کند.
- پورت‌های 8000 (وب) و 5000 (GPS) را اکسپوز می‌کند.

### `docker-compose.yml`
سرویس‌های زیر را تعریف می‌کند:
1.  **`db`**: دیتابیس PostgreSQL 15.
2.  **`redis`**: برای کش و صف‌های احتمالی.
3.  **`web`**: اپلیکیشن Django (Gunicorn). پورت 5000 را به هاست متصل می‌کند.
4.  **`nginx`**: وب‌سرور و ریورس پروکسی.

**نکته مهم**: کدها در `docker-compose.yml` به صورت Volume وصل نیستند (به جز static و media). بنابراین برای اعمال تغییرات کد، باید ایمیج‌ها **Rebuild** شوند (با دستور `docker compose up -d --build` یا اجرای مجدد `full_setup.sh`).

---

## راهنمای دیپلوی روی سرور

**آدرس سرور فعلی**: `91.107.135.136`

### مراحل نصب سریع

1.  **اتصال به سرور**:
    ```bash
    ssh root@91.107.135.136
    ```

2.  **انتقال فایل‌ها**:
    از سیستم خودتان فایل‌ها را با SCP یا Git منتقل کنید.

3.  **اجرای اسکریپت نصب**:
    ```bash
    cd GpsStore
    chmod +x full_setup.sh
    ./full_setup.sh
    ```
    این اسکریپت همه کارها (نصب داکر، بیلد، تنظیم دیتابیس و فایروال) را انجام می‌دهد.

4.  **بررسی وضعیت**:
    ```bash
    docker compose ps
    ```

### دسترسی‌ها
- **وب‌سایت**: `http://91.107.135.136`
- **پنل ادمین**: `http://91.107.135.136/admin/`
- **نام کاربری ادمین**: `root`
- **رمز عبور ادمین**: `iraj66100`

---

## عیب‌یابی (Troubleshooting)

### 1. خطای "Bad Gateway" (502)
- **علت**: کانتینر `web` اجرا نشده یا در حال ریستارت است.
- **بررسی**: `docker compose logs web`
- **راه‌حل رایج**: ممکن است فایل `docker-entrypoint.sh` دارای کاراکترهای ویندوزی (CRLF) باشد. اسکریپت `full_setup.sh` این را خودکار اصلاح می‌کند.

### 2. خطای "Too many clients already" در دیتابیس
- **علت**: باز ماندن اتصالات دیتابیس توسط ترد‌های گیرنده GPS یا لاگینگ بیش از حد در دیتابیس.
- **راه‌حل**:
    1. کد `gps_receiver.py` برای مدیریت بهینه اتصالات اصلاح شده است.
    2. **مهم**: سطح لاگینگ دیتابیس (`DatabaseLogHandler`) در `settings.py` باید روی `ERROR` باشد. اگر روی `DEBUG` باشد، تمام پیام‌های سیستمی در دیتابیس ذخیره شده و اتصالات را پر می‌کنند.

### 3. تغییرات کد اعمال نمی‌شود
- **علت**: کانتینرها با کد قدیمی در حال اجرا هستند.
- **راه‌حل**: باید بیلد مجدد انجام دهید:
    ```bash
    docker compose up -d --build
    docker compose restart
    ```

### 4. دستگاه وصل می‌شود اما داده ثبت نمی‌شود
- **بررسی**: جدول `RawGPSData` را در ادمین چک کنید. اگر داده با وضعیت `pending` و خطا وجود دارد، یعنی فرمت داده با `HQ_Decoder` سازگار نیست.

### 5. ریست کردن کامل (در صورت بروز مشکل حاد)
```bash
docker compose down -v  # حذف کانتینرها و والیوم‌ها (داده‌ها پاک می‌شوند!)
./full_setup.sh         # نصب مجدد از صفر
```
