{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}ردیابی زنده {{ device.name }}{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
.real-time-container {
    position: relative;
    height: calc(100vh - 200px);
}

#map {
    height: 100%;
    width: 100%;
    border-radius: 8px;
}

.status-panel {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 250px;
}

.status-item {
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.status-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.status-label {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 3px;
}

.status-value {
    font-weight: bold;
    color: #007bff;
}

.status-online {
    color: #28a745;
}

.status-offline {
    color: #dc3545;
}

.control-panel {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
}

.control-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn-control {
    padding: 8px 12px;
    border: 1px solid #007bff;
    background: white;
    color: #007bff;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    text-align: center;
    transition: all 0.2s;
}

.btn-control:hover {
    background: #007bff;
    color: white;
    text-decoration: none;
}

.btn-control.active {
    background: #007bff;
    color: white;
}

.btn-control.danger {
    border-color: #dc3545;
    color: #dc3545;
}

.btn-control.danger:hover {
    background: #dc3545;
    color: white;
}

.live-indicator {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(40, 167, 69, 0.9);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    z-index: 1000;
    display: none;
}

.live-indicator::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    margin-left: 8px;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.alert-notification {
    position: fixed;
    top: 20px;
    left: 20px;
    background: #dc3545;
    color: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 10000;
    max-width: 300px;
    display: none;
    cursor: pointer;
}

.alert-notification.show {
    display: block;
}

.alert-notification:hover {
    opacity: 0.9;
}

.tracking-path {
    stroke: #007bff;
    stroke-width: 4;
    fill: none;
}

.current-position {
    fill: #28a745;
    stroke: white;
    stroke-width: 2;
}

.geofence-area {
    fill: rgba(220, 53, 69, 0.2);
    stroke: #dc3545;
    stroke-width: 2;
}
</style>
{% endblock %}

{% block content %}
<div class="real-time-container">
    <!-- Map -->
    <div id="map"></div>

    <!-- Live Indicator -->
    <div id="live-indicator" class="live-indicator">
        ردیابی زنده فعال
    </div>

    <!-- Status Panel -->
    <div class="status-panel">
        <h5 class="mb-3">{{ device.name }}</h5>

        <div class="status-item">
            <div class="status-label">وضعیت اتصال</div>
            <div id="connection-status" class="status-value status-offline">در حال اتصال...</div>
        </div>

        <div class="status-item">
            <div class="status-label">آخرین بروزرسانی</div>
            <div id="last-update" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">موقعیت فعلی</div>
            <div id="current-position" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">سرعت</div>
            <div id="current-speed" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">باتری</div>
            <div id="battery-level" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">زمان اتصال</div>
            <div id="connection-time" class="status-value">-</div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="control-buttons">
            <a href="#" id="btn-start" class="btn-control active">
                <i class="fas fa-play"></i> شروع
            </a>
            <a href="#" id="btn-stop" class="btn-control">
                <i class="fas fa-stop"></i> توقف
            </a>
            <a href="#" id="btn-center" class="btn-control">
                <i class="fas fa-crosshairs"></i> مرکز
            </a>
            <a href="{% url 'tracking:device_tracking' device.id %}" class="btn-control">
                <i class="fas fa-history"></i> تاریخچه
            </a>
            <a href="#" id="btn-fullscreen" class="btn-control">
                <i class="fas fa-expand"></i> تمام صفحه
            </a>
        </div>
    </div>

    <!-- Alert Notification -->
    <div id="alert-notification" class="alert-notification">
        <h6><i class="fas fa-exclamation-triangle"></i> هشدار</h6>
        <p id="alert-message">هشداری دریافت شد</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const deviceId = {{ device.id }};
const deviceName = '{{ device.name }}';
const locationsUrl = "{% url 'tracking:get_device_locations' device.id %}";
const initialLocations = {{ initial_locations|safe }};
</script>
<script src="{% static 'js/real_time_tracking.js' %}"></script>
{% endblock %}