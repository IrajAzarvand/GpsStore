{% load static %}
<!-- Chart.js for interactive charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- <script src="https://static.neshan.org/sdk/leaflet/v1.9.4/neshan-sdk/v1.0.8/index.js"></script> -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const ACCESS_TOKEN = '{{ access_token }}';
    const WS_URL = `${protocol}${window.location.host}/ws/device-updates/?token=${ACCESS_TOKEN}`;
    const POLL_URL = "/gps_devices/api/markers/";
    const POLL_INTERVAL_SEC = 5;
    const NESHAN_KEY = '{{ NESHAN_MAP_API_KEY }}';
    const MARKER_BASE_URL = '{% static "img/markers/" %}';
    // --- State ---
    let map;
    let devices = {};
    let followingDeviceId = null;



    // --- Theme Toggle Function ---
    function updateThemeSwitcherUI() {
        const isLight = document.body.classList.contains('light-theme');

        const themeIcon = document.querySelector('.theme-icon');
        if (themeIcon) {
            if (isLight) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        const themeText = document.querySelector('.theme-switcher .theme-text');
        if (themeText) {
            themeText.textContent = isLight ? 'تم روشن' : 'تم تیره';
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
        updateThemeSwitcherUI();
        // Save theme preference to localStorage
        localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
    }

    // --- Load saved theme on page load ---
    document.addEventListener('DOMContentLoaded', function () {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
        }

        updateThemeSwitcherUI();
    });

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function () {
        // Only initialize map if the map container exists
        const mapContainer = document.getElementById('mainMap');
        if (mapContainer) {
            initMap();
            // Call onMapReady if defined (for WebSocket initialization)
            if (typeof onMapReady === 'function') {
                onMapReady();
            }
        }
    });




    let currentLayer = 'osm';
    let neshanLayer, osmLayer;

    function initMap() {
        if (map) return; // Prevent re-initialization

        const mapContainer = document.getElementById('mainMap');
        if (!mapContainer) {
            console.error("Map container 'mainMap' not found.");
            return;
        }

        console.log('Initializing map with OSM as default layer');
        try {
            map = L.map(mapContainer).setView([35.6892, 51.3890], 11);
        } catch (e) {
            console.error("Error initializing map:", e);
            return;
        }

        map.zoomControl = false; // We use custom controls
        map.options.inertia = false; // برای جلوگیری از کشیده‌شدن ناخواسته

        // OSM layer ENABLED for test
        osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Create Neshan layer (not added by default)
        neshanLayer = L.tileLayer(
            "https://api.neshan.org/v4/tiles/nezami/{z}/{x}/{y}",
            {
                attribution: "© Neshan",
                apiKey: NESHAN_KEY
            }
        );

        console.log('Map created:', map);

        // با تغییر اندازه، مرکز تصحیح شود
        window.addEventListener('resize', () => {
            map.invalidateSize();
            if (followingDeviceId && devices[followingDeviceId]) {
                const d = devices[followingDeviceId];
                if (d.lat && d.lng) map.setView([d.lat, d.lng], map.getZoom(), { animate: false });
            }
        });


        // Fix map attribution z-index to stay below bottom panel
        function fixMapAttributionZIndex() {
            const applyZIndexFix = () => {
                // Find all attribution elements
                const attributionElements = document.querySelectorAll(
                    '.leaflet-control-attribution, .leaflet-bottom, .leaflet-bottom.leaflet-right, .leaflet-bottom.leaflet-left'
                );

                attributionElements.forEach(el => {
                    // Set z-index on the element itself
                    if (el) {
                        el.style.setProperty('z-index', '100', 'important');

                        // Also fix all child elements
                        const children = el.querySelectorAll('*');
                        children.forEach(child => {
                            child.style.setProperty('z-index', '100', 'important');
                        });
                    }
                });
            };

            // Apply immediately
            setTimeout(applyZIndexFix, 100);
            setTimeout(applyZIndexFix, 500);
            setTimeout(applyZIndexFix, 1000);

            // Watch for changes using MutationObserver
            const observer = new MutationObserver(() => {
                applyZIndexFix();
            });

            // Observe the map container
            const mapContainer = document.getElementById('mainMap');
            if (mapContainer) {
                observer.observe(mapContainer, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
            }

            // Also check periodically to ensure z-index stays fixed
            setInterval(applyZIndexFix, 2000);
        }


        // Fix map attribution z-index to stay below bottom panel
        fixMapAttributionZIndex();

       


        // Initialize from server data
        const initialDevices = JSON.parse('{{ device_data_json|escapejs }}');
        console.log('Initial devices from server:', initialDevices.length);
        initialDevices.forEach(d => devices[d.id] = d);





        // Fit bounds if devices exist
        if (initialDevices.length > 0) {
            const bounds = [];

            initialDevices.forEach(d => {
                if (d.lat && d.lng) bounds.push([d.lat, d.lng]);
            });

            if (bounds.length > 0) map.fitBounds(bounds, {
                padding: [50, 50]
            });
        }
    }

    function switchMapLayer(layerType) {
        if (layerType === currentLayer) return;

        // Remove current layer
        if (currentLayer === 'neshan') {
            map.removeLayer(neshanLayer);
        } else if (currentLayer === 'osm') {
            map.removeLayer(osmLayer);
        }

        // Add new layer
        if (layerType === 'neshan') {
            map.addLayer(neshanLayer);
        } else if (layerType === 'osm') {
            map.addLayer(osmLayer);
        }

        currentLayer = layerType;
    }
</script>

