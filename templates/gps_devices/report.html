{% extends "gps_devices/template.html" %}
{% load static %}
{% block page_styles %}
<style>
    /* Full Screen Map */
    .report-map {
        position: fixed;
        top: 60px;
        /* Below header */
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    /* Floating Form Overlay */
    .floating-form-overlay {
        position: fixed;
        top: 80px;
        right: 20px;
        width: 400px;
        max-width: calc(100% - 40px);
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .overlay-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px 16px 0 0;
        cursor: pointer;
    }

    .overlay-header .header-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #4361ee, #4895ef);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: white;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
    }

    .overlay-header h3 {
        flex: 1;
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        margin: 0;
    }

    .toggle-form-btn {
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .toggle-form-btn:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .toggle-form-btn i {
        transition: transform 0.3s ease;
    }

    .floating-form-overlay.collapsed .toggle-form-btn i {
        transform: rotate(180deg);
    }

    .overlay-form-content {
        padding: 20px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        transition: all 0.3s ease;
    }

    .floating-form-overlay.collapsed .overlay-form-content {
        max-height: 0;
        padding: 0 20px;
        overflow: hidden;
    }

    .overlay-form-content::-webkit-scrollbar {
        width: 6px;
    }

    .overlay-form-content::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    .overlay-form-content::-webkit-scrollbar-thumb {
        background: rgba(72, 149, 239, 0.5);
        border-radius: 3px;
    }

    .report-form-compact {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .form-row .form-field:only-child {
        grid-column: 1 / -1;
    }

    .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-field label {
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .form-field label i {
        color: #4895ef;
        font-size: 0.7rem;
    }

    .compact-input {
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 0.85rem;
        font-family: 'Vazirmatn', sans-serif;
        transition: all 0.3s ease;
    }

    .compact-input:focus {
        outline: none;
        border-color: #4895ef;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
    }

    .compact-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.8rem;
    }

    .compact-input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
    }

    /* Custom Select Dropdown */
    .custom-select-wrapper {
        position: relative;
        width: 100%;
    }

    .custom-select {
        position: relative;
        width: 100%;
    }

    .select-trigger {
        padding: 14px 40px; /* Increased padding */
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px; /* Slightly more rounded */
        color: white;
        font-size: 1rem; /* Larger font */
        font-family: 'Vazirmatn', sans-serif;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        min-height: 50px; /* Larger height */
    }

    .select-trigger:hover {
        border-color: rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.12);
    }

    .select-trigger.active {
        border-color: #4895ef;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
    }

    .selected-text {
        flex: 1;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }

    .selected-text.placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .select-trigger i {
        color: #4895ef;
        transition: transform 0.3s ease;
        font-size: 0.9rem;
    }

    .select-trigger.active i {
        transform: rotate(180deg);
    }

    .select-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        width: 100%; /* Ensure full width matches parent */
        min-width: 100%; /* Prevent shrinking */
        box-sizing: border-box; /* Include padding/border in width */
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.98));
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 320px;
        display: flex;
        flex-direction: column;
    }

    .select-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .search-box {
        padding: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px 12px 0 0;
    }

    .search-box i {
        color: #4895ef;
        font-size: 0.85rem;
    }

    .search-box input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: white;
        font-size: 0.85rem;
        font-family: 'Vazirmatn', sans-serif;
    }

    .search-box input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .select-options {
        overflow-y: auto;
        max-height: 250px;
        padding: 6px;
    }

    .select-options::-webkit-scrollbar {
        width: 6px;
    }

    .select-options::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    .select-options::-webkit-scrollbar-thumb {
        background: rgba(72, 149, 239, 0.5);
        border-radius: 3px;
    }

    .select-options::-webkit-scrollbar-thumb:hover {
        background: rgba(72, 149, 239, 0.7);
    }

    .select-option {
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .select-option i {
        color: #4895ef;
        font-size: 0.8rem;
        opacity: 0.7;
    }

    .select-option:hover {
        background: rgba(72, 149, 239, 0.15);
        color: white;
    }

    .select-option:hover i {
        opacity: 1;
    }

    .select-option.selected {
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.3), rgba(72, 149, 239, 0.2));
        color: white;
        font-weight: 600;
    }

    .select-option.selected i {
        opacity: 1;
    }

    .select-option.hidden {
        display: none;
    }

    .submit-btn-overlay {
        padding: 12px 20px;
        background: linear-gradient(135deg, #4361ee, #4895ef);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 0.9rem;
        font-weight: 600;
        font-family: 'Vazirmatn', sans-serif;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
        width: 100%;
    }

    .submit-btn-overlay:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(67, 97, 238, 0.6);
    }

    .submit-btn-overlay:active {
        transform: translateY(0);
    }

    /* Report Bottom Panel (Dashboard Design) */
    .report-bottom-panel {
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        height: 480px; /* Increased height for dashboard */
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.98));
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        z-index: 900;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        overflow: hidden;
    }

    @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Date Tabs Header */
    .date-tabs-header {
        height: 55px;
        background: rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        padding: 0 10px;
        gap: 10px;
        flex-shrink: 0;
    }

    .date-tabs-scroll {
        flex: 1;
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 8px 0;
        scrollbar-width: none;
    }
    .date-tabs-scroll::-webkit-scrollbar { display: none; }

    .date-tab-btn {
        padding: 6px 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.6);
        font-family: 'Vazirmatn', sans-serif;
        cursor: pointer;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }

    .date-tab-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }
    .date-tab-btn.active {
        background: linear-gradient(135deg, #4361ee, #4895ef);
        border-color: #4361ee;
        color: white;
    }

    .date-tab-btn .badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 1px 5px;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    .close-panel-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: transparent;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .close-panel-btn:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; border-color: #ef4444; }

    /* Content Area */
    .date-content-area {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .day-tab-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
    }

    /* Daily Summary Summary */
    .daily-summary-bar {
        display: flex;
        gap: 20px;
        padding: 12px 20px;
        background: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .summary-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .summary-item .label { font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); }
    .summary-item .value { font-size: 1rem; font-weight: 700; color: white; }
    .summary-item .value small { font-size: 0.7rem; font-weight: 400; opacity: 0.7; }

    /* Split View Container */
    .split-view-container {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    /* Left Column: Points List */
    .points-list-scroll {
        width: 300px;
        overflow-y: auto;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }
    .points-list-scroll::-webkit-scrollbar { width: 4px; }
    .points-list-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); }

    .compact-point-item {
        padding: 10px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background 0.2s;
    }
    .compact-point-item:hover { background: rgba(255, 255, 255, 0.05); }
    .compact-point-item.active { background: rgba(72, 149, 239, 0.15); border-right: 3px solid #4895ef; }

    .point-time { width: 60px; font-size: 0.85rem; font-weight: 600; color: rgba(255, 255, 255, 0.9); }
    .point-status-icon { font-size: 0.6rem; opacity: 0.8; }
    .status-moving { color: #10b981; }
    .status-stopped, .status-parked, .status-idle { color: #f59e0b; }
    .status-alert { color: #ef4444; }
    .status-offline { color: #64748b; }

    .point-summary { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .point-summary .speed { font-size: 0.8rem; color: #4895ef; font-weight: 600; }
    .point-summary .addr-preview { font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Right Column: Detail Dashboard */
    .detail-dashboard {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        gap: 20px;
    }

    .detail-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 1rem;
        color: white;
        font-weight: 500;
    }
    .detail-header i { color: #4895ef; }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }

    .detail-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.2s;
    }
    .detail-card:hover { transform: translateY(-2px); background: rgba(255, 255, 255, 0.06); }

    .detail-card.speed-card { grid-row: span 2; background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(72, 149, 239, 0.05)); border-color: rgba(72, 149, 239, 0.3); }
    .speed-card .card-value { font-size: 2rem !important; color: #4895ef !important; }

    .card-icon { font-size: 1.2rem; color: rgba(255, 255, 255, 0.4); margin-bottom: 4px; }
    .card-value { font-size: 1.1rem; font-weight: 700; color: white; }
    .card-label { font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); }
    .status-text { font-size: 0.9rem; }

    @media (max-width: 768px) {
        .report-bottom-panel { height: 80vh; border-radius: 20px 20px 0 0; bottom: 0; left: 0; right: 0; }
        .split-view-container { flex-direction: column; }
        .points-list-scroll { width: 100%; height: 150px; border-left: none; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .daily-summary-bar { overflow-x: auto; }
        .summary-item { min-width: 80px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    {% include "gps_devices/includes/map_container.html" %}
    {% include "gps_devices/includes/map_controls.html" %}
</div>
{% endblock %}


{% block report_form %}
<!-- Floating Form Overlay -->
<div class="floating-form-overlay">
    <div class="overlay-header">
        <div class="header-icon">
            <i class="fas fa-route"></i>
        </div>
        <h3>گزارش مسیر</h3>
        <button class="toggle-form-btn" id="toggleFormBtn">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>

    <div class="overlay-form-content" id="overlayFormContent">
        <form method="POST" id="reportForm" class="report-form-compact">
            {% csrf_token %}

            <div class="form-row">
                <div class="form-field">
                    <label><i class="fas fa-microchip"></i> دستگاه</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="customDeviceSelect">
                            <div class="select-trigger">
                                <span class="selected-text">انتخاب دستگاه...</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="select-dropdown">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="deviceSearch" placeholder="جستجو...">
                                </div>
                                <div class="select-options">
                                    {% for device in devices %}
                                    <div class="select-option" data-value="{{ device.id }}">
                                        <i class="fas fa-microchip"></i>
                                        <span>{{ device.name }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="devices" id="deviceSelect" required>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label><i class="fas fa-calendar-alt"></i> از تاریخ</label>
                    <input type="text" name="start_date" id="startDate" class="compact-input" placeholder="تاریخ شروع"
                        required readonly>
                </div>

                <div class="form-field">
                    <label><i class="fas fa-clock"></i> ساعت</label>
                    <input type="time" name="start_time" id="startTime" class="compact-input" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label><i class="fas fa-calendar-check"></i> تا تاریخ</label>
                    <input type="text" name="end_date" id="endDate" class="compact-input" placeholder="تاریخ پایان"
                        required readonly>
                </div>

                <div class="form-field">
                    <label><i class="fas fa-clock"></i> ساعت</label>
                    <input type="time" name="end_time" id="endTime" class="compact-input" required>
                </div>
            </div>

            <button type="submit" class="submit-btn-overlay">
                <i class="fas fa-search"></i>
                <span>نمایش مسیر</span>
            </button>
        </form>
    </div>
</div>
<!-- Results Sidebar Panel (shown after form submission) -->
<!-- New Bottom Panel for Report Results -->
{% if report_data %}
<div class="report-bottom-panel" id="reportBottomPanel">
    
    <!-- Date Tabs -->
    <div class="date-tabs-header">
        <div class="date-tabs-scroll">
            {% for day in report_data %}
            <button class="date-tab-btn {% if forloop.first %}active{% endif %}" onclick="switchReportTab('{{ day.date }}', this)">
                <i class="far fa-calendar-alt"></i>
                {{ day.date }}
                <span class="badge">{{ day.stats.total_points }}</span>
            </button>
            {% endfor %}
        </div>
        <button class="close-panel-btn" onclick="document.getElementById('reportBottomPanel').style.display='none'">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Content Area -->
    <div class="date-content-area">
        {% for day in report_data %}
        <div id="tab-{{ day.date }}" class="day-tab-content" style="display: {% if forloop.first %}flex{% else %}none{% endif %};">
            
            <!-- Daily Summary Board -->
            <div class="daily-summary-bar">
                <div class="summary-item">
                    <span class="label">مسافت کل</span>
                    <span class="value">{{ day.stats.distance }} <small>km</small></span>
                </div>
                <div class="summary-item">
                    <span class="label">حداکثر سرعت</span>
                    <span class="value">{{ day.stats.max_speed }} <small>km/h</small></span>
                </div>
                <div class="summary-item">
                    <span class="label">میانگین سرعت</span>
                    <span class="value">{{ day.stats.avg_speed }} <small>km/h</small></span>
                </div>
                <div class="summary-item">
                    <span class="label">حرکت</span>
                    <span class="value">{{ day.stats.move_percent }}%</span>
                </div>
            </div>

            <!-- Split View: List + Details -->
            <div class="split-view-container">
                
                <!-- Left: Compact List -->
                <div class="points-list-scroll">
                    {% for record in day.points %}
                    <div class="compact-point-item" 
                         onclick="focusOnPoint(this, {{ record.latitude }}, {{ record.longitude }})"
                         data-time="{{ record.shamsi_time }}"
                         data-speed="{{ record.speed|floatformat:0 }}"
                         data-status="{{ record.status }}"
                         data-address="{{ record.address }}"
                         data-altitude="{{ record.altitude }}"
                         data-satellites="{{ record.satellites }}"
                         data-battery="{{ record.battery }}"
                         data-signal="{{ record.signal }}"
                         data-direction="{{ record.direction }}"
                         data-lat="{{ record.latitude }}"
                         data-lng="{{ record.longitude }}">
                        
                        <div class="point-time">
                            <span>{{ record.shamsi_time }}</span>
                        </div>
                        <div class="point-status-icon status-{{ record.status }}">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="point-summary">
                            <span class="speed">{{ record.speed|floatformat:0 }} km/h</span>
                            <span class="addr-preview">{{ record.address|truncatechars:30 }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Right: Detailed Dashboard -->
                <div class="detail-dashboard">
                    <div class="detail-header">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="detail-address-{{ day.date }}">برای مشاهده جزئیات یک نقطه را انتخاب کنید</span>
                    </div>

                    <div class="detail-grid">
                        <!-- Speed Gauge -->
                        <div class="detail-card speed-card">
                            <div class="card-icon"><i class="fas fa-tachometer-alt"></i></div>
                            <div class="card-value" id="detail-speed-{{ day.date }}">-</div>
                            <div class="card-label">سرعت (km/h)</div>
                        </div>

                        <!-- Time -->
                        <div class="detail-card">
                            <div class="card-icon"><i class="fas fa-clock"></i></div>
                            <div class="card-value" id="detail-time-{{ day.date }}">-</div>
                            <div class="card-label">زمان</div>
                        </div>

                        <!-- Status -->
                        <div class="detail-card">
                            <div class="card-icon"><i class="fas fa-info-circle"></i></div>
                            <div class="card-value status-text" id="detail-status-{{ day.date }}">-</div>
                            <div class="card-label">وضعیت</div>
                        </div>

                        <!-- Sensors -->
                        <div class="detail-card">
                            <div class="card-icon"><i class="fas fa-mountain"></i></div>
                            <div class="card-value" id="detail-altitude-{{ day.date }}">-</div>
                            <div class="card-label">ارتفاع</div>
                        </div>

                        <div class="detail-card">
                            <div class="card-icon"><i class="fas fa-satellite"></i></div>
                            <div class="card-value" id="detail-satellite-{{ day.date }}">-</div>
                            <div class="card-label">ماهواره</div>
                        </div>

                        <div class="detail-card">
                            <div class="card-icon"><i class="fas fa-car-battery"></i></div>
                            <div class="card-value" id="detail-battery-{{ day.date }}">-</div>
                            <div class="card-label">باتری</div>
                        </div>

                        <div class="detail-card">
                            <div class="card-icon"><i class="fas fa-signal"></i></div>
                            <div class="card-value" id="detail-signal-{{ day.date }}">-</div>
                            <div class="card-label">سیگنال</div>
                        </div>

                        <div class="detail-card">
                            <div class="card-icon"><i class="fas fa-compass"></i></div>
                            <div class="card-value" id="detail-direction-{{ day.date }}">-</div>
                            <div class="card-label">جهت</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    let currentTab = '{{ report_data.0.date }}';

    function switchReportTab(date, btn) {
        // Hide all tabs
        document.querySelectorAll('.day-tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.date-tab-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected
        const tab = document.getElementById('tab-' + date);
        tab.style.display = 'flex';
        btn.classList.add('active');
        currentTab = date;
    }

    function focusOnPoint(el, lat, lng) {
        // 1. Center Map
        if(window.map) {
            window.map.setView([lat, lng], 17);
            L.marker([lat, lng]).addTo(window.map)
             .bindPopup('نقطه انتخاب شده').openPopup();
        }

        // 2. Highlight List Item
        // Remove active class from all items in this tab
        const container = el.closest('.points-list-scroll');
        container.querySelectorAll('.compact-point-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');

        // 3. Update Dashboard
        const data = el.dataset;
        const date = currentTab; 
        
        // Helper to set text
        const setText = (id, val) => {
            const el = document.getElementById(id + '-' + date);
            if(el) el.innerText = val || '-';
        };

        setText('detail-address', data.address);
        setText('detail-speed', data.speed);
        setText('detail-time', data.time);
        setText('detail-status', data.status);
        setText('detail-altitude', data.altitude);
        setText('detail-satellite', data.satellites);
        setText('detail-battery', data.battery + '%');
        setText('detail-signal', data.signal + '%');
        setText('detail-direction', data.direction + '°');
    }
</script>
{% endif %}
{% endblock %}



{% block page_scripts %}
<script>
    $(document).ready(function () {
    
        // Initialize Persian Date Pickers
        $('#startDate').persianDatepicker({
            format: 'YYYY-MM-DD',
            initialValue: true,
            autoClose: true,
            calendar: {
                persian: {
                    locale: 'fa'
                }
            },
            navigator: {
                enabled: true
            },
            toolbox: {
                enabled: true
            },
            timePicker: {
                enabled: false
            }
        });

        $('#endDate').persianDatepicker({
            format: 'YYYY-MM-DD',
            initialValue: true,
            autoClose: true,
            calendar: {
                persian: {
                    locale: 'fa'
                }
            },
            navigator: {
                enabled: true
            },
            toolbox: {
                enabled: true
            },
            timePicker: {
                enabled: false
            }
        });

        // Set default time values
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        $('#startTime').val('00:00');
        $('#endTime').val(hours + ':' + minutes);

        // Custom Select Dropdown Functionality
        const customSelect = document.getElementById('customDeviceSelect');
        const selectTrigger = customSelect.querySelector('.select-trigger');
        const selectDropdown = customSelect.querySelector('.select-dropdown');
        const selectedText = customSelect.querySelector('.selected-text');
        const hiddenInput = document.getElementById('deviceSelect');
        const searchInput = document.getElementById('deviceSearch');
        const options = customSelect.querySelectorAll('.select-option');

        // Toggle dropdown
        selectTrigger.addEventListener('click', function (e) {
            e.stopPropagation();
            selectTrigger.classList.toggle('active');
            selectDropdown.classList.toggle('active');

            if (selectDropdown.classList.contains('active')) {
                searchInput.focus();
            }
        });

        // Select option
        options.forEach(option => {
            option.addEventListener('click', function () {
                const value = this.getAttribute('data-value');
                const text = this.querySelector('span').textContent;

                // Update hidden input
                hiddenInput.value = value;

                // Update display text
                selectedText.textContent = text;
                selectedText.classList.remove('placeholder');

                // Update selected state
                options.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');

                // Close dropdown
                selectTrigger.classList.remove('active');
                selectDropdown.classList.remove('active');

                // Clear search
                searchInput.value = '';
                options.forEach(opt => opt.classList.remove('hidden'));
            });
        });

        // Search functionality
        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase().trim();

            options.forEach(option => {
                const text = option.querySelector('span').textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!customSelect.contains(e.target)) {
                selectTrigger.classList.remove('active');
                selectDropdown.classList.remove('active');
            }
        });

        // Prevent dropdown close when clicking inside
        selectDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Toggle form collapse
        const toggleFormBtn = document.getElementById('toggleFormBtn');
        const floatingFormOverlay = document.querySelector('.floating-form-overlay');

        if (toggleFormBtn) {
            toggleFormBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                floatingFormOverlay.classList.toggle('collapsed');
            });
        }


        // Display route on map if report data exists
        {% if report_data %}
        const routePoints = [
            {% for record in report_data %}
            {
            lat: {{ record.latitude }},
            lng: {{ record.longitude }},
            time: '{{ record.shamsi_timestamp }}',
            speed: {{ record.speed }},
            direction: {{ record.direction }}
            }{% if not forloop.last %}, {% endif %}
            {% endfor %}
        ];

        if (routePoints.length > 0) {
            // Create polyline for route
            const latlngs = routePoints.map(p => [p.lat, p.lng]);
            const polyline = L.polyline(latlngs, {
                color: '#4361ee',
                weight: 4,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(map);

            // Add markers for start and end points
            const startIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #22c55e; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-play"></i></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const endIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #ef4444; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-stop"></i></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker([routePoints[0].lat, routePoints[0].lng], { icon: startIcon })
                .addTo(map)
                .bindPopup('<b>شروع مسیر</b><br>' + routePoints[0].time);

            L.marker([routePoints[routePoints.length - 1].lat, routePoints[routePoints.length - 1].lng], { icon: endIcon })
                .addTo(map)
                .bindPopup('<b>پایان مسیر</b><br>' + routePoints[routePoints.length - 1].time);

            // Fit map to route bounds
            map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
            
            // Expose map to window for external access
            window.map = map;
        }
        {% endif %}

        // Form submission
        $('#reportForm').on('submit', function () {
            const btn = $('.submit-btn-overlay');
            btn.html('<i class="fas fa-spinner fa-spin"></i> <span>در حال بارگذاری...</span>');
            btn.css('pointer-events', 'none');
        });
    });
</script>

{% endblock %}