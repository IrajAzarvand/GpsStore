{% extends "gps_devices/template.html" %}

{% block form_section %}
<div class="report-form" style="display: flex; justify-content: space-around; align-items: center; padding: 10px; background-color: #f0f0f0; border: 1px solid #ccc; width: 100%;">
<form method="post">
{% csrf_token %}
<label for="devices">دستگاه‌ها:</label>
<select name="devices" id="devices" multiple>
{% for device in devices %}
<option value="{{ device.id }}">{{ device.name }}</option>
{% endfor %}
</select>
<label for="start_date">تاریخ شروع:</label>
<input type="text" name="start_date" placeholder="تاریخ شروع">
<label for="start_time">زمان شروع:</label>
<input type="text" name="start_time" placeholder="زمان شروع">
<label for="end_date">تاریخ پایان:</label>
<input type="text" name="end_date" placeholder="تاریخ پایان">
<label for="end_time">زمان پایان:</label>
<input type="text" name="end_time" placeholder="زمان پایان">
<button type="submit">تایید</button>
</form>
</div>
{% endblock %}



{% block content %}


<div class="map-container" style="width: 100%; height: 70vh;">
    <div id="mainMap"></div>
    <div class="map-controls"><button class="control-btn" title="بزرگنمایی" onclick="map.zoomIn()"><i
                class="fas fa-plus"></i></button><button class="control-btn" title="کوچکنمایی"
            onclick="map.zoomOut()"><i class="fas fa-minus"></i></button><button class="control-btn"
            title="موقعیت من" onclick="locateUser()"><i class="fas fa-crosshairs"></i></button><button
            class="control-btn" title="لایه‌ها" onclick="toggleLayers()"><i
                class="fas fa-layer-group"></i></button>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<!-- Polyline Decoder for Map Matching -->
<script>

    let devicePolylines = {}; // ذخیره Polyline هر دستگاه


    // تابع decode کردن Encoded Polyline
    function decodePolyline(encoded) {
        if (!encoded) return [];

        let points = [];
        let index = 0, len = encoded.length;
        let lat = 0, lng = 0;

        while (index < len) {
            let b, shift = 0, result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += dlat;

            shift = 0;
            result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += dlng;

            points.push([lat / 1e5, lng / 1e5]);
        }

        return points;
    }


    function createMarkers() {
        Object.values(devices).forEach(device => {
            updateDeviceMarker(device);
            // Polyline اگر وجود داشت
            if (device.matched_geometry) {
                updateDevicePolyline(device.id, device.matched_geometry);
            }
            // همیشه وضعیت آیکون را به‌روز کن
            updateDeviceStatusIcons(device);
        });
    }
    
    // رسم یا به‌روزرسانی Polyline برای یک دستگاه
    function updateDevicePolyline(deviceId, geometry) {
        // حذف Polyline قبلی اگر وجود داشت
        if (devicePolylines[deviceId]) {
            map.removeLayer(devicePolylines[deviceId]);
            delete devicePolylines[deviceId];
        }

        // اگر geometry وجود نداشت، فقط حذف کن
        if (!geometry) {
            return;
        }

        try {
            // Decode کردن Encoded Polyline
            const points = decodePolyline(geometry);

            if (points && points.length > 0) {
                // ایجاد Polyline جدید
                const polyline = L.polyline(points, {
                    color: '#4361ee',        // رنگ آبی
                    weight: 4,               // ضخامت خط
                    opacity: 0.7,            // شفافیت
                    smoothFactor: 1.0        // نرمی خط
                }).addTo(map);

                // ذخیره برای استفاده بعدی
                devicePolylines[deviceId] = polyline;

                console.log(`Polyline drawn for device ${deviceId} with ${points.length} points`);
            }
        } catch (error) {
            console.error(`Error drawing polyline for device ${deviceId}:`, error);
        }
    }
    
</script>
{% endblock %}
